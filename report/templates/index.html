{#
Copyright 2024 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

#}{% extends 'base.html' %}

{% block content %}

<style>
td .benchmark .function,
td .signature {
    overflow-wrap: anywhere;
}

td .signature {
    width: fit-content;
    white-space: normal;
    padding: 5px 2px;
    margin: 5px 0 0;
    background: #eee;
    font-family: monospace;
    font-size: 14px;
}

.signature a {
    text-decoration: none;
}

.table-index {
    color: #555;
    font-size: 12px;
    text-align: center;
}


.sortable-table th {
    cursor: pointer;
}

.sortable-table th:after {
    content: ' \25be';
    color: #ccc;
}

.sortable-table th[data-sorted="asc"]:after {
    color: #000;
}

.sortable-table th[data-sorted="desc"]:after {
    content: ' \25b4';
    color: #000;
}

</style>

<table class="sortable-table" id="benchmark-table">
    <thead>
        <tr>
            <th></th>
            <th data-sorted="asc">Benchmark</th>
            <th>Status</th>
            <th data-sort-number>Build Rate</th>
            <th data-sort-number>Crash Rate</th>
            <th data-sort-number>Bugs</th>
            <th data-sort-number>Program Counter Coverage</th>
            <th data-sort-number>Line Coverage Diff</th>
        </tr>
    </thead>
    <tbody>
        {% for benchmark in benchmarks %}
        <tr>
            <td class="table-index">{{ loop.index }}</td>
            <td data-sort-value="{{ benchmark.id }}">
                <div class="project">{{ benchmark.project }}</div>
                <pre class="signature">
                    <a href="benchmark/{{ benchmark.id|urlencode }}/index.html">{{ benchmark.signature }}</a>
                </pre>
            </td>
            <td data-sort-value="{{ benchmark.status }}">{{ benchmark.status }}</td>
            <td data-sort-value="{{ benchmark.result.build_success_rate|percent }}">{{ benchmark.result.build_success_rate|percent}}</td>
            <td data-sort-value="{{ benchmark.result.crash_rate|percent }}"><a href="benchmark/{{ benchmark.id|urlencode }}/crash.json"> {{ benchmark.result.crash_rate|percent }} </a></td>
            <td data-sort-value="{{ benchmark.result.found_bug }}">{{ benchmark.result.found_bug }}</td>
            <td data-sort-value="{{ benchmark.result.max_coverage |percent }}">{{ benchmark.result.max_coverage |percent }}</td>
            <td data-sort-value="{{ benchmark.result.max_line_coverage_diff|percent }}"><a href="{{ benchmark.result.max_coverage_diff_report | cov_report_link }}">{{ benchmark.result.max_line_coverage_diff|percent }}</a></td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>Project summary</h2>
<table class="sortable-table" id="summary-table">
    <thead>
        <tr>
            <th></th>
            <th data-sorted="asc">Project</th>
            <th data-sort-number>Total benchmarks</th>
            <th data-sort-number>Successful benchmarks</th>
            <th data-sort-number>Total coverage gain</th>
            <th data-sort-number>Total relative gain</th>
            <th data-sort-number>OSS-Fuzz-gen total covered lines</th>
            <th data-sort-number>OSS-Fuzz-gen new covered lines</th>
            <th data-sort-number>Existing covered lines</th>
            <th data-sort-number>Total project lines</th>
        </tr>
    </thead>
    <tbody>
        {% for project in projects %}
        <tr>
            <td class="table-index">{{ loop.index }}</td>
            <td data-sort-value="{{ project.name }}">{{ project.name }}</td>
            <td data-sort-value="{{ project.count }}">{{ project.count }}</td>
            <td data-sort-value="{{ project.success }}">{{ project.success }}</td>
            <td data-sort-value="{{ project.coverage_gain|percent }}">{{ project.coverage_gain|percent }}%</td>
            <td data-sort-value="{{ project.coverage_relative_gain|percent}}">{{ project.coverage_relative_gain | percent }}%</td>
            <td data-sort-value="{{ project.coverage_ofg_total_covered_lines}}">{{project.coverage_ofg_total_covered_lines}}</td>
            <td data-sort-value="{{ project.coverage_ofg_total_new_covered_lines}}">{{ project.coverage_ofg_total_new_covered_lines}}</td>
            <td data-sort-value="{{ project.coverage_existing_total_covered_lines}}">{{ project.coverage_existing_total_covered_lines}}</td>
            <td data-sort-value="{{ project.coverage_existing_total_lines}}">{{ project.coverage_existing_total_lines}}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>Language coverage gains</h2>
<table class="sortable-table" id="language-coverage-gain">
    <thead>
        <th>language</th>
        <th>OSS-Fuzz total lines</th>
        <th>OSS-Fuzz coverage lines</th>
        <th>Experiment new coverage lines</th>
        <th>Increase of total</th>
        <th>Increase of covered</th>
    </thead>
    <tbody>
        {% for language in coverage_language_gains['coverage_gains_per_language'] %}
        <tr>
            <td>{{language}}</td>
            <td>{{coverage_language_gains['oss_fuzz_language_status'][language]['total']}}</td>
            <td>{{coverage_language_gains['oss_fuzz_language_status'][language]['covered']}}</td>
            <td>{{coverage_language_gains['coverage_gains_per_language'][language]}}</td>
            <td>{{coverage_language_gains['comperative_coverage_gains'][language]['total_coverage_increase']}}%</td>
            <td>{{coverage_language_gains['comperative_coverage_gains'][language]['relative_coverage_increase']}}%</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>Crashes found by generated fuzz harnesses</h2>
<table class="sortable-table" id="bug-summary-table">
    <thead>
        <tr>
            <th></th>
            <th data-sort-string>Project</th>
            <th data-sorted="asc">Benchmark</th>
            <th data-sort-string>AI bug validation</th>
        </tr>
    </thead>
    <tbody>
        {% for bug_sample in samples_with_bugs %}
        <tr>
            <td class="table-index">{{ loop.index }}</td>
            <td data-sort-value="{{bug_sample.benchmark.project}}">{{bug_sample.benchmark.project}}</td>
            <td data-sort-value="{{bug_sample.benchmark.id}}"><a href="sample/{{ bug_sample.benchmark.id|urlencode }}/{{ bug_sample.sample.id }}.html">{{bug_sample.benchmark.id}}-{{ bug_sample.sample.id }} </a> </td>
            <td style="color: {{ 'red' if bug_sample.sample.result.crashes and not bug_sample.sample.result.is_semantic_error else 'green' }}" data-sort-value="{{'True positive' if bug_sample.sample.result.is_semantic_error else 'False positive'}}">{{'True positive' if bug_sample.sample.result.is_semantic_error else 'False positive'}}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>Accumulated results</h2>
<table>
  <thead>
    <th>Metric</th>
    <th>Value</th>
  </thead>
  <tbody>
    <tr>
      <td>Total sample benchmarks</td>
      <td>{{ accumulated_results.total_runs }}</td>
    </tr>
    <tr>
      <td>Successful Builds</td>
      <td>{{ accumulated_results.compiles }}</td>
    </tr>
    <tr>
      <td>Build rate</td>
      <td>{{ accumulated_results.build_rate |percent }}%</td>
    </tr>
    <tr>
      <td>Average coverage</td>
      <td>{{ accumulated_results.average_coverage |percent }}%</td>
    </tr>
    <tr>
      <td>Average line coverage diff</td>
      <td>{{ accumulated_results.average_line_coverage_diff |percent }}%</td>
    </tr>
    <tr>
      <td>Benchmarks with crashes</td>
      <td>{{ accumulated_results.crashes }}</td>
    </tr>
    <tr>
        <td>Experiment start time</td>
        <td>{{time_results.start_time}}</td>
    </tr>
    <tr>
        <td>Experiment end time</td>
        <td>{{time_results.completion_time}}</td>
    </tr>
    <tr>
        <td>Experiment total run time</td>
        <td>{{time_results.total_run_time}}</td>
    </tr>
  </tbody>
</table>

<script>
(function() {
    tables = Array.from(document.querySelectorAll('table.sortable-table'));
    for (let tbl_idx1 = 0; tbl_idx1 < tables.length; tbl_idx1++) {
        table_element = tables[tbl_idx1];
        const table_id_name = table_element.id;
        headers = Array.from(table_element.querySelectorAll('th'));
        headers.map(
            (th, colindex) => th.addEventListener('click', () => {
                const sortAsc = th.dataset.sorted != "asc";
                const sortNumber = th.dataset.sortNumber != undefined;

                // Move sorted data attribute to the right column
                headers.map(innerTH => delete innerTH.dataset.sorted);
                th.dataset.sorted = sortAsc ? "asc" : "desc";

                // Find the relevant table and sort it accordingly.
                inner_tables = Array.from(document.querySelectorAll('table.sortable-table'));
                for (let tbl_idx2 = 0; tbl_idx2 < inner_tables.length; tbl_idx2++) {
                    the_table = inner_tables[tbl_idx2];
                    if (the_table.id == table_id_name) {
                        const tbody = the_table.querySelector('tbody');
                        const rows = Array.from(tbody.children);
                        rows.sort((a, b) => {
                            let [valueA, valueB] = [a.children[colindex].dataset.sortValue, b.children[colindex].dataset.sortValue];
                            // Swap the values for descending.
                            if (!sortAsc) {
                                [valueB, valueA] = [valueA, valueB];
                            }

                            if (sortNumber) {
                                return Number(valueB) - Number(valueA);
                            }
                            return valueA.localeCompare(valueB);
                        });
                        tbody.replaceChildren(...rows);
                        // Rewrite the index column
                        rows.map((r, i) => r.children[0].innerText = i);
                    }
                }
            }, )
        );
    }
    
    // Create search UI elements
    const searchContainer = document.createElement('div');
    searchContainer.style.margin = '20px 0';
    searchContainer.style.padding = '15px';
    searchContainer.style.backgroundColor = '#f8f9fa';
    searchContainer.style.border = '1px solid #dedede';
    searchContainer.style.borderRadius = '4px';
    
    const searchTitle = document.createElement('h2');
    searchTitle.textContent = 'Search Reports';
    
    const searchInput = document.createElement('input');
    searchInput.setAttribute('type', 'text');
    searchInput.setAttribute('placeholder', 'Search for projects, benchmarks, or other content...');
    searchInput.style.width = '100%';
    searchInput.style.padding = '8px';
    searchInput.style.border = '1px solid #ccc';
    searchInput.style.borderRadius = '4px';
    searchInput.style.fontSize = '16px';
    searchInput.style.marginBottom = '10px';
    
    // Add elements to DOM
    searchContainer.appendChild(searchTitle);
    searchContainer.appendChild(searchInput);
    
    // Add filter controls
    const filtersTitle = document.createElement('h3');
    filtersTitle.textContent = 'Filters';
    filtersTitle.style.marginTop = '15px';
    filtersTitle.style.marginBottom = '10px';
    searchContainer.appendChild(filtersTitle);
    
    // Filter containers
    const filtersContainer = document.createElement('div');
    filtersContainer.style.display = 'flex';
    filtersContainer.style.flexWrap = 'wrap';
    filtersContainer.style.gap = '20px';
    searchContainer.appendChild(filtersContainer);
    
    // Create benchmark table filters
    const benchmarkFilters = document.createElement('div');
    benchmarkFilters.style.flex = '1';
    benchmarkFilters.style.minWidth = '250px';
    
    const benchmarkTitle = document.createElement('h4');
    benchmarkTitle.textContent = 'Benchmark Filters';
    benchmarkTitle.style.marginBottom = '10px';
    benchmarkFilters.appendChild(benchmarkTitle);
    
    // Project filter (dropdown)
    const projectFilterContainer = document.createElement('div');
    projectFilterContainer.style.marginBottom = '10px';
    
    const projectLabel = document.createElement('label');
    projectLabel.textContent = 'Project:';
    projectLabel.style.display = 'block';
    projectLabel.style.marginBottom = '3px';
    
    const projectSelect = document.createElement('select');
    projectSelect.id = 'project-filter';
    projectSelect.dataset.tableId = 'benchmark-table';
    projectSelect.dataset.column = '1';
    projectSelect.dataset.filterType = 'select';
    projectSelect.style.width = '100%';
    projectSelect.style.padding = '5px';
    
    // Add default option
    const defaultProjectOption = document.createElement('option');
    defaultProjectOption.value = '';
    defaultProjectOption.textContent = 'All';
    projectSelect.appendChild(defaultProjectOption);
    
    // Get unique project values
    const benchmarkTable = document.getElementById('benchmark-table');
    if (benchmarkTable) {
        const uniqueProjects = new Set();
        Array.from(benchmarkTable.querySelectorAll('tbody tr')).forEach(row => {
            const projectCell = row.children[1];
            const projectName = projectCell.querySelector('.project')?.textContent;
            if (projectName) uniqueProjects.add(projectName);
        });
        
        // Add options for each project
        Array.from(uniqueProjects).sort().forEach(project => {
            const option = document.createElement('option');
            option.value = project;
            option.textContent = project;
            projectSelect.appendChild(option);
        });
    }
    
    projectFilterContainer.appendChild(projectLabel);
    projectFilterContainer.appendChild(projectSelect);
    benchmarkFilters.appendChild(projectFilterContainer);
    
    // Status filter (dropdown)
    const statusFilterContainer = document.createElement('div');
    statusFilterContainer.style.marginBottom = '10px';
    
    const statusLabel = document.createElement('label');
    statusLabel.textContent = 'Status:';
    statusLabel.style.display = 'block';
    statusLabel.style.marginBottom = '3px';
    
    const statusSelect = document.createElement('select');
    statusSelect.id = 'status-filter';
    statusSelect.dataset.tableId = 'benchmark-table';
    statusSelect.dataset.column = '2';
    statusSelect.dataset.filterType = 'select';
    statusSelect.style.width = '100%';
    statusSelect.style.padding = '5px';
    
    // Add default option
    const defaultStatusOption = document.createElement('option');
    defaultStatusOption.value = '';
    defaultStatusOption.textContent = 'All';
    statusSelect.appendChild(defaultStatusOption);
    
    // Get unique status values
    if (benchmarkTable) {
        const uniqueStatuses = new Set();
        Array.from(benchmarkTable.querySelectorAll('tbody tr')).forEach(row => {
            const statusCell = row.children[2];
            const statusValue = statusCell.dataset.sortValue || statusCell.textContent.trim();
            if (statusValue) uniqueStatuses.add(statusValue);
        });
        
        // Add options for each status
        Array.from(uniqueStatuses).sort().forEach(status => {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status;
            statusSelect.appendChild(option);
        });
    }
    
    statusFilterContainer.appendChild(statusLabel);
    statusFilterContainer.appendChild(statusSelect);
    benchmarkFilters.appendChild(statusFilterContainer);
    
    // Build Rate filter (slider)
    const buildRateFilterContainer = document.createElement('div');
    buildRateFilterContainer.style.marginBottom = '15px';
    
    const buildRateLabel = document.createElement('label');
    buildRateLabel.textContent = 'Min Build Rate:';
    buildRateLabel.style.display = 'block';
    buildRateLabel.style.marginBottom = '3px';
    
    // Create slider container to show the value
    const buildRateSliderContainer = document.createElement('div');
    buildRateSliderContainer.style.display = 'flex';
    buildRateSliderContainer.style.alignItems = 'center';
    buildRateSliderContainer.style.gap = '10px';
    
    const buildRateSlider = document.createElement('input');
    buildRateSlider.type = 'range';
    buildRateSlider.id = 'build-rate-filter';
    buildRateSlider.dataset.tableId = 'benchmark-table';
    buildRateSlider.dataset.column = '3';
    buildRateSlider.dataset.filterType = 'range';
    buildRateSlider.min = 0;
    buildRateSlider.max = 100;
    buildRateSlider.step = 5;
    buildRateSlider.value = 0;
    buildRateSlider.style.width = '70%';
    
    const buildRateValue = document.createElement('span');
    buildRateValue.textContent = '0%';
    buildRateValue.style.width = '40px';
    buildRateValue.style.textAlign = 'right';
    
    buildRateSlider.addEventListener('input', () => {
        buildRateValue.textContent = buildRateSlider.value + '%';
    });
    
    buildRateSliderContainer.appendChild(buildRateSlider);
    buildRateSliderContainer.appendChild(buildRateValue);
    
    buildRateFilterContainer.appendChild(buildRateLabel);
    buildRateFilterContainer.appendChild(buildRateSliderContainer);
    benchmarkFilters.appendChild(buildRateFilterContainer);
    
    // Crash Rate filter (slider)
    const crashRateFilterContainer = document.createElement('div');
    crashRateFilterContainer.style.marginBottom = '15px';
    
    const crashRateLabel = document.createElement('label');
    crashRateLabel.textContent = 'Min Crash Rate:';
    crashRateLabel.style.display = 'block';
    crashRateLabel.style.marginBottom = '3px';
    
    // Create slider container
    const crashRateSliderContainer = document.createElement('div');
    crashRateSliderContainer.style.display = 'flex';
    crashRateSliderContainer.style.alignItems = 'center';
    crashRateSliderContainer.style.gap = '10px';
    
    const crashRateSlider = document.createElement('input');
    crashRateSlider.type = 'range';
    crashRateSlider.id = 'crash-rate-filter';
    crashRateSlider.dataset.tableId = 'benchmark-table';
    crashRateSlider.dataset.column = '4';
    crashRateSlider.dataset.filterType = 'range';
    crashRateSlider.min = 0;
    crashRateSlider.max = 100;
    crashRateSlider.step = 5;
    crashRateSlider.value = 0;
    crashRateSlider.style.width = '70%';
    
    const crashRateValue = document.createElement('span');
    crashRateValue.textContent = '0%';
    crashRateValue.style.width = '40px';
    crashRateValue.style.textAlign = 'right';
    
    crashRateSlider.addEventListener('input', () => {
        crashRateValue.textContent = crashRateSlider.value + '%';
    });
    
    crashRateSliderContainer.appendChild(crashRateSlider);
    crashRateSliderContainer.appendChild(crashRateValue);
    
    crashRateFilterContainer.appendChild(crashRateLabel);
    crashRateFilterContainer.appendChild(crashRateSliderContainer);
    benchmarkFilters.appendChild(crashRateFilterContainer);
    
    // Coverage filter (slider)
    const coverageFilterContainer = document.createElement('div');
    coverageFilterContainer.style.marginBottom = '15px';
    
    const coverageLabel = document.createElement('label');
    coverageLabel.textContent = 'Min Coverage:';
    coverageLabel.style.display = 'block';
    coverageLabel.style.marginBottom = '3px';
    
    // Create slider container
    const coverageSliderContainer = document.createElement('div');
    coverageSliderContainer.style.display = 'flex';
    coverageSliderContainer.style.alignItems = 'center';
    coverageSliderContainer.style.gap = '10px';
    
    const coverageSlider = document.createElement('input');
    coverageSlider.type = 'range';
    coverageSlider.id = 'coverage-filter';
    coverageSlider.dataset.tableId = 'benchmark-table';
    coverageSlider.dataset.column = '6';
    coverageSlider.dataset.filterType = 'range';
    coverageSlider.min = 0;
    coverageSlider.max = 100;
    coverageSlider.step = 5;
    coverageSlider.value = 0;
    coverageSlider.style.width = '70%';
    
    const coverageValue = document.createElement('span');
    coverageValue.textContent = '0%';
    coverageValue.style.width = '40px';
    coverageValue.style.textAlign = 'right';
    
    coverageSlider.addEventListener('input', () => {
        coverageValue.textContent = coverageSlider.value + '%';
    });
    
    coverageSliderContainer.appendChild(coverageSlider);
    coverageSliderContainer.appendChild(coverageValue);
    
    coverageFilterContainer.appendChild(coverageLabel);
    coverageFilterContainer.appendChild(coverageSliderContainer);
    benchmarkFilters.appendChild(coverageFilterContainer);
    
    // Add Bugs filter (checkbox)
    const bugFilterContainer = document.createElement('div');
    bugFilterContainer.style.marginBottom = '15px';
    
    const bugLabel = document.createElement('label');
    bugLabel.style.display = 'flex';
    bugLabel.style.alignItems = 'center';
    bugLabel.style.gap = '5px';
    bugLabel.style.cursor = 'pointer';
    
    const bugCheckbox = document.createElement('input');
    bugCheckbox.type = 'checkbox';
    bugCheckbox.id = 'bugs-filter';
    bugCheckbox.dataset.tableId = 'benchmark-table';
    bugCheckbox.dataset.column = '5';
    bugCheckbox.dataset.filterType = 'checkbox';
    
    const bugLabelText = document.createTextNode('Show only benchmarks with bugs');
    
    bugLabel.appendChild(bugCheckbox);
    bugLabel.appendChild(bugLabelText);
    
    bugFilterContainer.appendChild(bugLabel);
    benchmarkFilters.appendChild(bugFilterContainer);
    
    // Add benchmark filters to the container
    filtersContainer.appendChild(benchmarkFilters);
    
    // Create project summary filters
    const projectSummaryFilters = document.createElement('div');
    projectSummaryFilters.style.flex = '1';
    projectSummaryFilters.style.minWidth = '250px';
    
    const projectSummaryTitle = document.createElement('h4');
    projectSummaryTitle.textContent = 'Project Summary Filters';
    projectSummaryTitle.style.marginBottom = '10px';
    projectSummaryFilters.appendChild(projectSummaryTitle);
    
    // Project name filter for summary table
    const projectNameFilterContainer = document.createElement('div');
    projectNameFilterContainer.style.marginBottom = '10px';
    
    const projectNameLabel = document.createElement('label');
    projectNameLabel.textContent = 'Project Name:';
    projectNameLabel.style.display = 'block';
    projectNameLabel.style.marginBottom = '3px';
    
    const projectNameSelect = document.createElement('select');
    projectNameSelect.id = 'project-name-filter';
    projectNameSelect.dataset.tableId = 'summary-table';
    projectNameSelect.dataset.column = '1';
    projectNameSelect.dataset.filterType = 'select';
    projectNameSelect.style.width = '100%';
    projectNameSelect.style.padding = '5px';
    
    // Add default option
    const defaultProjectNameOption = document.createElement('option');
    defaultProjectNameOption.value = '';
    defaultProjectNameOption.textContent = 'All';
    projectNameSelect.appendChild(defaultProjectNameOption);
    
    // Get unique project names from summary table
    const summaryTable = document.getElementById('summary-table');
    if (summaryTable) {
        const uniqueProjectNames = new Set();
        Array.from(summaryTable.querySelectorAll('tbody tr')).forEach(row => {
            const projectNameCell = row.children[1];
            const projectName = projectNameCell.dataset.sortValue || projectNameCell.textContent.trim();
            if (projectName) uniqueProjectNames.add(projectName);
        });
        
        // Add options for each project name
        Array.from(uniqueProjectNames).sort().forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            projectNameSelect.appendChild(option);
        });
    }
    
    projectNameFilterContainer.appendChild(projectNameLabel);
    projectNameFilterContainer.appendChild(projectNameSelect);
    projectSummaryFilters.appendChild(projectNameFilterContainer);
    
    // Coverage Gain filter (slider)
    const coverageGainFilterContainer = document.createElement('div');
    coverageGainFilterContainer.style.marginBottom = '15px';
    
    const coverageGainLabel = document.createElement('label');
    coverageGainLabel.textContent = 'Min Coverage Gain:';
    coverageGainLabel.style.display = 'block';
    coverageGainLabel.style.marginBottom = '3px';
    
    // Create slider container
    const coverageGainSliderContainer = document.createElement('div');
    coverageGainSliderContainer.style.display = 'flex';
    coverageGainSliderContainer.style.alignItems = 'center';
    coverageGainSliderContainer.style.gap = '10px';
    
    const coverageGainSlider = document.createElement('input');
    coverageGainSlider.type = 'range';
    coverageGainSlider.id = 'coverage-gain-filter';
    coverageGainSlider.dataset.tableId = 'summary-table';
    coverageGainSlider.dataset.column = '4';
    coverageGainSlider.dataset.filterType = 'range';
    coverageGainSlider.min = 0;
    coverageGainSlider.max = 100;
    coverageGainSlider.step = 1;
    coverageGainSlider.value = 0;
    coverageGainSlider.style.width = '70%';
    
    const coverageGainValue = document.createElement('span');
    coverageGainValue.textContent = '0%';
    coverageGainValue.style.width = '40px';
    coverageGainValue.style.textAlign = 'right';
    
    coverageGainSlider.addEventListener('input', () => {
        coverageGainValue.textContent = coverageGainSlider.value + '%';
    });
    
    coverageGainSliderContainer.appendChild(coverageGainSlider);
    coverageGainSliderContainer.appendChild(coverageGainValue);
    
    coverageGainFilterContainer.appendChild(coverageGainLabel);
    coverageGainFilterContainer.appendChild(coverageGainSliderContainer);
    projectSummaryFilters.appendChild(coverageGainFilterContainer);
    
    // Success Rate filter (slider)
    const successRateFilterContainer = document.createElement('div');
    successRateFilterContainer.style.marginBottom = '15px';
    
    const successRateLabel = document.createElement('label');
    successRateLabel.textContent = 'Min Success Rate:';
    successRateLabel.style.display = 'block';
    successRateLabel.style.marginBottom = '3px';
    
    // Create slider container
    const successRateSliderContainer = document.createElement('div');
    successRateSliderContainer.style.display = 'flex';
    successRateSliderContainer.style.alignItems = 'center';
    successRateSliderContainer.style.gap = '10px';
    
    const successRateSlider = document.createElement('input');
    successRateSlider.type = 'range';
    successRateSlider.id = 'success-rate-filter';
    successRateSlider.dataset.tableId = 'summary-table';
    successRateSlider.dataset.column = '3'; // Column for Successful benchmarks
    successRateSlider.dataset.compareColumn = '2'; // Column for Total benchmarks
    successRateSlider.dataset.filterType = 'success-rate';
    successRateSlider.min = 0;
    successRateSlider.max = 100;
    successRateSlider.step = 5;
    successRateSlider.value = 0;
    successRateSlider.style.width = '70%';
    
    const successRateValue = document.createElement('span');
    successRateValue.textContent = '0%';
    successRateValue.style.width = '40px';
    successRateValue.style.textAlign = 'right';
    
    successRateSlider.addEventListener('input', () => {
        successRateValue.textContent = successRateSlider.value + '%';
    });
    
    successRateSliderContainer.appendChild(successRateSlider);
    successRateSliderContainer.appendChild(successRateValue);
    
    successRateFilterContainer.appendChild(successRateLabel);
    successRateFilterContainer.appendChild(successRateSliderContainer);
    projectSummaryFilters.appendChild(successRateFilterContainer);
    
    // Add project summary filters to the container
    filtersContainer.appendChild(projectSummaryFilters);
    
    // Create language coverage filters
    const languageFilters = document.createElement('div');
    languageFilters.style.flex = '1';
    languageFilters.style.minWidth = '250px';
    
    const languageTitle = document.createElement('h4');
    languageTitle.textContent = 'Language Coverage Filters';
    languageTitle.style.marginBottom = '10px';
    languageFilters.appendChild(languageTitle);
    
    // Language filter (dropdown)
    const languageFilterContainer = document.createElement('div');
    languageFilterContainer.style.marginBottom = '10px';
    
    const languageLabel = document.createElement('label');
    languageLabel.textContent = 'Language:';
    languageLabel.style.display = 'block';
    languageLabel.style.marginBottom = '3px';
    
    const languageSelect = document.createElement('select');
    languageSelect.id = 'language-filter';
    languageSelect.dataset.tableId = 'language-coverage-gain';
    languageSelect.dataset.column = '0';
    languageSelect.dataset.filterType = 'select';
    languageSelect.style.width = '100%';
    languageSelect.style.padding = '5px';
    
    // Add default option
    const defaultLanguageOption = document.createElement('option');
    defaultLanguageOption.value = '';
    defaultLanguageOption.textContent = 'All';
    languageSelect.appendChild(defaultLanguageOption);
    
    // Get unique language values
    const languageTable = document.getElementById('language-coverage-gain');
    if (languageTable) {
        const uniqueLanguages = new Set();
        Array.from(languageTable.querySelectorAll('tbody tr')).forEach(row => {
            const languageCell = row.children[0];
            const language = languageCell.textContent.trim();
            if (language) uniqueLanguages.add(language);
        });
        
        // Add options for each language
        Array.from(uniqueLanguages).sort().forEach(language => {
            const option = document.createElement('option');
            option.value = language;
            option.textContent = language;
            languageSelect.appendChild(option);
        });
    }
    
    languageFilterContainer.appendChild(languageLabel);
    languageFilterContainer.appendChild(languageSelect);
    languageFilters.appendChild(languageFilterContainer);
    
    // Coverage Increase filter (slider)
    const coverageIncreaseFilterContainer = document.createElement('div');
    coverageIncreaseFilterContainer.style.marginBottom = '15px';
    
    const coverageIncreaseLabel = document.createElement('label');
    coverageIncreaseLabel.textContent = 'Min Coverage Increase:';
    coverageIncreaseLabel.style.display = 'block';
    coverageIncreaseLabel.style.marginBottom = '3px';
    
    // Create slider container
    const coverageIncreaseSliderContainer = document.createElement('div');
    coverageIncreaseSliderContainer.style.display = 'flex';
    coverageIncreaseSliderContainer.style.alignItems = 'center';
    coverageIncreaseSliderContainer.style.gap = '10px';
    
    const coverageIncreaseSlider = document.createElement('input');
    coverageIncreaseSlider.type = 'range';
    coverageIncreaseSlider.id = 'coverage-increase-filter';
    coverageIncreaseSlider.dataset.tableId = 'language-coverage-gain';
    coverageIncreaseSlider.dataset.column = '5'; // Column for relative increase
    coverageIncreaseSlider.dataset.filterType = 'range';
    coverageIncreaseSlider.min = 0;
    coverageIncreaseSlider.max = 100;
    coverageIncreaseSlider.step = 1;
    coverageIncreaseSlider.value = 0;
    coverageIncreaseSlider.style.width = '70%';
    
    const coverageIncreaseValue = document.createElement('span');
    coverageIncreaseValue.textContent = '0%';
    coverageIncreaseValue.style.width = '40px';
    coverageIncreaseValue.style.textAlign = 'right';
    
    coverageIncreaseSlider.addEventListener('input', () => {
        coverageIncreaseValue.textContent = coverageIncreaseSlider.value + '%';
    });
    
    coverageIncreaseSliderContainer.appendChild(coverageIncreaseSlider);
    coverageIncreaseSliderContainer.appendChild(coverageIncreaseValue);
    
    coverageIncreaseFilterContainer.appendChild(coverageIncreaseLabel);
    coverageIncreaseFilterContainer.appendChild(coverageIncreaseSliderContainer);
    languageFilters.appendChild(coverageIncreaseFilterContainer);
    
    // Add language filters to the container
    filtersContainer.appendChild(languageFilters);
    
    // Reset button
    const resetButtonContainer = document.createElement('div');
    resetButtonContainer.style.marginTop = '15px';
    resetButtonContainer.style.textAlign = 'right';
    
    const resetButton = document.createElement('button');
    resetButton.textContent = 'Reset Filters';
    resetButton.style.padding = '6px 12px';
    resetButton.style.backgroundColor = '#f44336';
    resetButton.style.color = 'white';
    resetButton.style.border = 'none';
    resetButton.style.borderRadius = '4px';
    resetButton.style.cursor = 'pointer';
    
    resetButton.addEventListener('click', () => {
        // Reset all filter inputs
        document.querySelectorAll('select').forEach(input => {
            input.value = '';
        });
        
        // Reset range inputs
        document.querySelectorAll('input[type="range"]').forEach(slider => {
            slider.value = slider.min;
            // Update the associated value display
            const sliderContainer = slider.parentElement;
            const valueDisplay = sliderContainer.querySelector('span');
            if (valueDisplay) {
                valueDisplay.textContent = slider.min + '%';
            }
        });
        
        // Reset checkbox inputs
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // Clear the search input
        searchInput.value = '';
        
        // Show all rows
        document.querySelectorAll('table.sortable-table tbody tr').forEach(row => {
            row.style.display = '';
        });
    });
    
    resetButtonContainer.appendChild(resetButton);
    searchContainer.appendChild(resetButtonContainer);
    
    // Insert search container at the top of the page
    const firstTable = document.querySelector('table');
    firstTable.parentNode.insertBefore(searchContainer, firstTable);
    
    // Enhanced search function that includes filters
    function performSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const tables = document.querySelectorAll('table.sortable-table');
        
        // Get filter values for benchmark table
        const projectFilter = document.getElementById('project-filter').value;
        const statusFilter = document.getElementById('status-filter').value;
        const buildRateFilter = parseInt(document.getElementById('build-rate-filter').value);
        const crashRateFilter = parseInt(document.getElementById('crash-rate-filter').value);
        const coverageFilter = parseInt(document.getElementById('coverage-filter').value);
        const bugsFilter = document.getElementById('bugs-filter').checked;
        
        // Get filter values for project summary table
        const projectNameFilter = document.getElementById('project-name-filter').value;
        const coverageGainFilter = parseInt(document.getElementById('coverage-gain-filter').value);
        const successRateFilter = parseInt(document.getElementById('success-rate-filter').value);
        
        // Get filter values for language coverage table
        const languageFilter = document.getElementById('language-filter').value;
        const coverageIncreaseFilter = parseInt(document.getElementById('coverage-increase-filter').value);
        
        tables.forEach(table => {
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const tableId = table.id;
            
            rows.forEach(row => {
                // Always check global search first
                const text = row.textContent.toLowerCase();
                let isMatch = searchTerm === '' || text.includes(searchTerm);
                
                // Apply table-specific filters
                if (isMatch && tableId === 'benchmark-table') {
                    // Project filter
                    if (projectFilter) {
                        const projectCell = row.children[1];
                        const projectName = projectCell.querySelector('.project')?.textContent;
                        if (projectName !== projectFilter) isMatch = false;
                    }
                    
                    // Status filter
                    if (isMatch && statusFilter) {
                        const statusCell = row.children[2];
                        const statusValue = statusCell.dataset.sortValue || statusCell.textContent.trim();
                        if (statusValue !== statusFilter) isMatch = false;
                    }
                    
                    // Build Rate filter (slider)
                    if (isMatch && buildRateFilter > 0) {
                        const buildRateCell = row.children[3];
                        const buildRateText = buildRateCell.textContent.trim();
                        const buildRateValue = parseFloat(buildRateText.replace('%', ''));
                        if (isNaN(buildRateValue) || buildRateValue < buildRateFilter) isMatch = false;
                    }
                    
                    // Crash Rate filter (slider)
                    if (isMatch && crashRateFilter > 0) {
                        const crashRateCell = row.children[4];
                        const crashRateText = crashRateCell.textContent.trim();
                        const crashRateValue = parseFloat(crashRateText.replace('%', ''));
                        if (isNaN(crashRateValue) || crashRateValue < crashRateFilter) isMatch = false;
                    }
                    
                    // Has Bugs filter (checkbox)
                    if (isMatch && bugsFilter) {
                        const bugsCell = row.children[5];
                        const bugsValue = parseInt(bugsCell.textContent.trim());
                        if (isNaN(bugsValue) || bugsValue <= 0) isMatch = false;
                    }
                    
                    // Coverage filter (slider)
                    if (isMatch && coverageFilter > 0) {
                        const coverageCell = row.children[6];
                        const coverageText = coverageCell.textContent.trim();
                        const coverageValue = parseFloat(coverageText.replace('%', ''));
                        if (isNaN(coverageValue) || coverageValue < coverageFilter) isMatch = false;
                    }
                    
                } else if (isMatch && tableId === 'summary-table') {
                    // Project name filter for summary table
                    if (projectNameFilter) {
                        const projectNameCell = row.children[1];
                        const projectName = projectNameCell.dataset.sortValue || projectNameCell.textContent.trim();
                        if (projectName !== projectNameFilter) isMatch = false;
                    }
                    
                    // Coverage Gain filter (slider)
                    if (isMatch && coverageGainFilter > 0) {
                        const coverageGainCell = row.children[4];
                        const coverageGainText = coverageGainCell.textContent.trim();
                        const coverageGainValue = parseFloat(coverageGainText.replace('%', ''));
                        if (isNaN(coverageGainValue) || coverageGainValue < coverageGainFilter) isMatch = false;
                    }
                    
                    // Success Rate filter (slider)
                    if (isMatch && successRateFilter > 0) {
                        const totalCell = row.children[2];
                        const successCell = row.children[3];
                        const totalValue = parseInt(totalCell.textContent.trim());
                        const successValue = parseInt(successCell.textContent.trim());
                        
                        if (!isNaN(totalValue) && !isNaN(successValue) && totalValue > 0) {
                            const successRate = (successValue / totalValue) * 100;
                            if (successRate < successRateFilter) isMatch = false;
                        }
                    }
                    
                } else if (isMatch && tableId === 'language-coverage-gain') {
                    // Language filter
                    if (languageFilter) {
                        const languageCell = row.children[0];
                        const language = languageCell.textContent.trim();
                        if (language !== languageFilter) isMatch = false;
                    }
                    
                    // Coverage Increase filter (slider)
                    if (isMatch && coverageIncreaseFilter > 0) {
                        const coverageIncreaseCell = row.children[5];
                        const coverageIncreaseText = coverageIncreaseCell.textContent.trim();
                        const coverageIncreaseValue = parseFloat(coverageIncreaseText.replace('%', ''));
                        if (isNaN(coverageIncreaseValue) || coverageIncreaseValue < coverageIncreaseFilter) isMatch = false;
                    }
                }
                
                // Toggle row visibility based on all filter results
                row.style.display = isMatch ? '' : 'none';
            });
        });
    }
    
    // Add event listeners to search and filters
    searchInput.addEventListener('input', performSearch);
    
    // Add event listeners to all filter inputs
    document.querySelectorAll('select, input[type="range"], input[type="checkbox"]').forEach(input => {
        if (input.type === 'range') {
            input.addEventListener('input', performSearch);
        } else {
            input.addEventListener('change', performSearch);
        }
    });
})();
</script>
{% endblock %}
